<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuber Freak Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'EB Garamond', serif;
            background-color: #f0f2f5;
        }
        .sheet-container {
            border: 2px solid #1f2937;
            position: relative; /* For remove button */
        }
        .section {
            border: 1px solid #9ca3af;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure sections fill grid cells */
        }
        .section-title {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            color: #4b5563;
        }
        .input-field, .textarea-field {
            width: 100%;
            border: none;
            border-bottom: 1px solid #9ca3af;
            background-color: transparent;
            padding: 0.25rem 0.1rem;
            font-family: 'EB Garamond', serif;
            resize: none; /* Disable manual resize */
        }
        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-bottom: 2px solid #3b82f6;
        }
        .attribute-table {
            width: 100%;
            border-collapse: collapse;
        }
        .attribute-table th, .attribute-table td {
            border: 1px solid #9ca3af;
            text-align: center;
            padding: 0.25rem;
            font-size: 0.75rem;
        }
         .attribute-table th {
            background-color: #e5e7eb;
            font-weight: bold;
         }
        .attribute-table input {
            width: 100%;
            text-align: center;
            border: none;
            background: transparent;
            font-family: 'EB Garamond', serif;
        }
        .attribute-table input:focus {
            outline:none;
        }
        .highlight-entry {
            background-color: #eff6ff !important; /* A very light blue background */
        }
        .remove-freak-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            z-index: 10;
        }
        .remove-freak-btn:hover {
            color: #ef4444;
        }

        /* --- Dark Mode Styles --- */
        .dark-mode {
            background-color: #111827;
            color: #d1d5db;
        }
        .dark-mode .sheet-container {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        .dark-mode .section {
            border-color: #4b5563;
        }
        .dark-mode .border-b-2 {
            border-color: #6b7280;
        }
        .dark-mode .section-title, .dark-mode .label-sm {
            color: #9ca3af;
        }
        .dark-mode .input-field, .dark-mode .textarea-field {
            color: #e5e7eb;
            border-bottom-color: #4b5563;
        }
        .dark-mode .input-field:focus, .dark-mode .textarea-field:focus {
            border-bottom-color: #60a5fa;
        }
        .dark-mode .attribute-table th, .dark-mode .attribute-table td {
            border-color: #4b5563;
        }
        .dark-mode .attribute-table th {
            background-color: #374151;
        }
        .dark-mode .attribute-table input {
            color: #e5e7eb;
        }
        .dark-mode .bg-gray-100 {
            background-color: #374151 !important;
        }
         .dark-mode .bg-gray-200 {
            background-color: #4b5563 !important;
        }
        .dark-mode .highlight-entry {
            background-color: #1e293b !important;
        }
        .dark-mode .freak-total-cost {
            color: #60a5fa;
        }
        .dark-mode #warband-cost-display {
             color: #60a5fa;
        }
         .dark-mode .remove-freak-btn {
            color: #4b5563;
        }
        .dark-mode .remove-freak-btn:hover {
            color: #fca5a5;
        }
    </style>
</head>
<body class="p-4 md:p-8 transition-colors duration-300">

    <!-- Global Header -->
    <div class="max-w-4xl mx-auto mb-4">
        <div class="flex justify-between items-start">
            <h1 class="text-xl md:text-2xl font-bold uppercase tracking-widest text-center flex-grow">Tuber Freak Creator</h1>
            <!-- Theme Toggle -->
             <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16">
                    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                </svg>
                <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-200 focus:outline-none">
                    <span id="theme-toggle-indicator" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                </button>
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                    <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
                </svg>
            </div>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-center mt-2 border-b-2 border-gray-700 pb-2 mb-2 gap-4">
            <!-- Warband Name -->
            <div class="flex items-center gap-2 w-full md:w-auto">
                <label for="warband-name" class="font-bold uppercase text-lg">Warband Name:</label>
                <input type="text" id="warband-name" name="warband-name" class="input-field highlight-entry flex-grow" value="My Warband">
            </div>
            <!-- Total Cost -->
            <div class="flex items-center gap-2 flex-shrink-0">
                <span class="font-bold uppercase text-lg">Total Warband Cost:</span>
                <span id="warband-cost-display" class="text-xl md:text-2xl font-bold text-blue-600">0</span>
            </div>
        </div>
    </div>
    
    <!-- Container for all freak cards -->
    <div id="warband-container" class="space-y-4">
        <!-- Freak cards will be injected here -->
    </div>

    <!-- Add Freak Button -->
    <div class="max-w-4xl mx-auto mt-4">
        <button id="add-freak-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
            + Add New Freak
        </button>
    </div>

    <!-- 
    =========================================
    FREAK TEMPLATE
    =========================================
    -->
    <template id="freak-template">
        <main class="sheet-container max-w-4xl mx-auto bg-white shadow-lg p-4 grid grid-cols-12 gap-2">
            <button class="remove-freak-btn" title="Remove Freak">&times;</button>
            <!-- Main Content Area -->
            <div class="col-span-12 grid grid-cols-12 gap-2">

                <!-- Header -->
                <div class="col-span-12 border-b-2 border-gray-700 pb-2 mb-2 flex justify-between items-center">
                    <!-- Name -->
                    <div class="flex-grow">
                        <label for="name" class="section-title">Name:</label>
                        <input type="text" name="name" class="input-field highlight-entry name-input">
                    </div>
                    <!-- Freak Cost -->
                    <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                        <span class="font-bold uppercase text-lg">Freak Cost:</span>
                        <span class="freak-total-cost text-xl md:text-2xl font-bold text-blue-600">0</span>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="col-span-12 grid grid-cols-1 md:grid-cols-2 gap-2">
                    
                    <!-- Left Column -->
                    <div class="grid grid-cols-1 gap-2 auto-rows-min">
                        <!-- Leader Toggle -->
                        <div class="section flex-row justify-between items-center">
                            <label for="is-leader" class="section-title !mb-0">Leader Status:</label>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" name="is-leader" class="h-5 w-5 text-blue-600 rounded highlight-entry focus:ring-blue-500 is-leader-toggle">
                                <span class="text-sm font-bold">Leader</span>
                            </div>
                        </div>
                        
                        <!-- Attributes -->
                        <div class="section">
                            <h2 class="section-title text-center">Characteristics</h2>
                            <table class="attribute-table">
                                <thead>
                                    <tr>
                                        <th>CHA</th>
                                        <th>LVL</th>
                                        <th>COST</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>BLU</td>
                                        <td>
                                            <select name="blu_level" class="input-field level-select bg-white w-full text-center highlight-entry">
                                                <option value="1-4">1-4</option>
                                                <option value="1-3">1-3</option>
                                                <option value="1-2">1-2</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="blu_cost" readonly class="bg-gray-100 cost-input"></td>
                                    </tr>
                                    <tr>
                                        <td>SPD</td>
                                        <td>
                                            <select name="spd_level" class="input-field level-select bg-white w-full text-center highlight-entry">
                                                <option value="1 Chain">1 Chain</option>
                                                <option value="2 Chains">2 Chains</option>
                                                <option value="3 Chains">3 Chains</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="spd_cost" readonly class="bg-gray-100 cost-input"></td>
                                    </tr>
                                    <tr>
                                        <td>RNG</td>
                                        <td>
                                            <select name="rng_level" data-keymap="rng" class="input-field level-select bg-white w-full text-center highlight-entry">
                                                <option value="2d6">2d6</option>
                                                <option value="2d8">2d8</option>
                                                <option value="2d10">2d10</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="rng_cost" readonly class="bg-gray-100 cost-input"></td>
                                    </tr>
                                    <tr>
                                        <td>MEL</td>
                                        <td>
                                            <select name="mel_level" data-keymap="mel" class="input-field level-select bg-white w-full text-center highlight-entry">
                                                <option value="2d6">2d6</option>
                                                <option value="2d8">2d8</option>
                                                <option value="2d10">2d10</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="mel_cost" readonly class="bg-gray-100 cost-input"></td>
                                    </tr>
                                    <tr>
                                        <td>WtL</td>
                                        <td>
                                            <select name="wtl_level" data-keymap="wtl" class="input-field level-select bg-white w-full text-center highlight-entry">
                                                <option value="2d6">2d6</option>
                                                <option value="2d8">2d8</option>
                                                <option value="2d10">2d10</option>
                                            </select>
                                        </td>
                                        <td><input type="text" name="wtl_cost" readonly class="bg-gray-100 cost-input"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Leader Trait (Hidden by default) -->
                        <div class="section leader-trait-section hidden">
                            <div class="flex justify-between items-center">
                                <label for="leader-trait" class="section-title">Leader Trait:</label>
                                <button class="generate-leader-trait-btn text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md transition duration-300">Generate Trait</button>
                            </div>
                            <textarea name="leader-trait" rows="6" class="textarea-field flex-grow highlight-entry mt-2 leader-trait-textarea"></textarea>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="grid grid-cols-1 gap-2 auto-rows-min">
                        <!-- Equipment -->
                        <div class="section">
                            <label for="equipment" class="section-title">Equipment:</label>
                            <select name="equipment" class="input-field bg-white highlight-entry equipment-select">
                                <option value="" selected>Select Equipment</option>
                                <option value="Black Powder Weapons">Black Powder Weapons</option>
                                <option value="Missile Weapons">Missile Weapons</option>
                                <option value="Close Combat Weapons">Close Combat Weapons</option>
                            </select>
                            <label for="equipment_notes" class="section-title mt-2">Notes:</label>
                            <textarea name="equipment_notes" rows="6" class="textarea-field flex-grow bg-gray-100 equipment-notes" readonly></textarea>
                        </div>

                        <!-- Quirk -->
                        <div class="section">
                            <div class="flex justify-between items-center">
                                <label for="quirk" class="section-title">Quirk:</label>
                                <button class="generate-quirk-btn text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md transition duration-300">Generate Quirk</button>
                            </div>
                            <textarea name="quirk" rows="6" class="textarea-field flex-grow highlight-entry mt-2 quirk-textarea"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </template>


    <script>
        document.addEventListener('DOMContentLoaded', function() {

        // --- DATA OBJECTS ---
        const tuberAttributeData = {
            // Blunder
            "1-4": { cost: 1 },
            "1-3": { cost: 2 },
            "1-2": { cost: 3 },
            // Speed
            "1 Chain": { cost: 0 },
            "2 Chains": { cost: 1 },
            "3 Chains": { cost: 3 },
            // Range Attack
            "2d6": { cost: 2 },
            "2d8": { cost: 4 },
            "2d10": { cost: 6 },
            // Melee Attack (using unique keys)
            "2d6-mel": { cost: 2 },
            "2d8-mel": { cost: 4 },
            "2d10-mel": { cost: 6 },
            // Will to Live (using unique keys)
            "2d6-wtl": { cost: 2 },
            "2d8-wtl": { cost: 4 },
            "2d10-wtl": { cost: 8 },
        };
        
        const equipmentData = {
            "Black Powder Weapons": "This freak gets +1DL to range attacks. Gain a black powder token after resolving any ranged attack.",
            "Missile Weapons": "This freak does not accrue black powder tokens after shooting. However, the defending freak gets +1 to both their will to live and under volley rolls.",
            "Close Combat Weapons": "This freak can only make melee attacks. However, OpR it may reroll the result of a blunder made if attempting a Strike! or Charge! action."
        };

        const quirkList = [
            { name: "Weaponized Whimpering", text: "As an instant action, this freak gains 1 panic token to get +1DL to this Freak’s next WTL roll." },
            { name: "Panicked Hack", text: "As an instant action, this freak gains 1 panic token to get +1DL to this Freak’s next MEL roll." },
            { name: "Hysterical Volley", text: "As an instant action, this freak gains 1 panic token to get +1DL to this Freak’s next RNG roll." },
            { name: "Gormless Spite", text: "As an instant action, this freak gains 2 panic token to get +1DL to this Freak’s next opposed roll." },
            { name: "Hopeless Acceptance", text: "As an instant action, remove 2 panic tokens. However this freak gets -2DL to its next opposed roll." },
            { name: "True Son of God", text: "If this freak goes OoA, it may instead make another friendly freak go OoA in its place." }
        ];

        const leaderTraitList = [
            { name: "The Deflector", text: "OpR and as an instant action, this Freak can reroll a blunder by giving another friendly Freak a panic token." },
            { name: "Good Riddance", text: "When this Freak goes OoA, all other Freaks in your warband remove 2 panic tokens." },
            { name: "The Narcissist", text: "OpR and as an instant action, this leader can give another Freak a panic token and +1DL to its next opposed roll." },
            { name: "The Micromanager", text: "Reduce the blunder chance of friendly Freaks by 1. However, blundering causes 2 panic tokens instead of 1." },
            { name: "The Energy Vampire", text: "All Freaks within line of sight of this leader gains an extra token whenever they accrue panic." },
            { name: "The Mule", text: "OpR and as an instant action, this Freak can accrue 2 panic tokens to let another friendly Freak reroll an opposed roll." }
        ];

        
        // --- GLOBAL DOM ELEMENTS ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeToggleIndicator = document.getElementById('theme-toggle-indicator');
        const body = document.body;
        const warbandContainer = document.getElementById('warband-container');
        const addFreakBtn = document.getElementById('add-freak-btn');
        const freakTemplate = document.getElementById('freak-template');
        const warbandCostDisplay = document.getElementById('warband-cost-display');

        // --- FUNCTIONS ---

        function applyTheme(theme) {
            if (theme === 'dark') {
                body.classList.add('dark-mode');
                themeToggleIndicator.style.transform = 'translateX(1.25rem)'; // 20px
                themeToggle.classList.remove('bg-gray-200');
                themeToggle.classList.add('bg-blue-600');
            } else {
                body.classList.remove('dark-mode');
                themeToggleIndicator.style.transform = 'translateX(0.25rem)'; // 4px
                themeToggle.classList.add('bg-gray-200');
                themeToggle.classList.remove('bg-blue-600');
            }
        }

        function autosizeTextarea(textarea) {
            if (!textarea) return;
            // Temporarily reset height to allow it to shrink
            textarea.style.height = 'auto';
            // Set the height to the scroll height, which is the full height of the content
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function updateWarbandCost() {
            let total = 0;
            document.querySelectorAll('.freak-total-cost').forEach(display => {
                total += parseInt(display.textContent) || 0;
            });
            warbandCostDisplay.textContent = total;
        }

        function calculateFreakCost(freakCard) {
            let total = 0;
            freakCard.querySelectorAll('.cost-input').forEach(input => {
                const value = parseInt(input.value, 10);
                if (!isNaN(value)) {
                    total += value;
                }
            });
            freakCard.querySelector('.freak-total-cost').textContent = total;
            updateWarbandCost(); // Update warband total whenever a freak's cost changes
        }

        function updateAttributeRow(selectElement) {
            const freakCard = selectElement.closest('.sheet-container');
            let level = selectElement.value;
            const row = selectElement.closest('tr');
            const costInput = row.querySelector('.cost-input');
            const keymap = selectElement.dataset.keymap;

            let dataKey = level;
            // Apply special mapping for RNG, MEL, WtL
            if (keymap === 'mel') dataKey = level + '-mel';
            else if (keymap === 'wtl') dataKey = level + '-wtl';
            
            const data = tuberAttributeData[dataKey];

            if (data) {
                costInput.value = data.cost;
            } else {
                costInput.value = '';
            }
            calculateFreakCost(freakCard);
        }
        
        function updateEquipmentNotes(selectElement) {
            const freakCard = selectElement.closest('.sheet-container');
            const selectedEquipment = selectElement.value;
            const notesTextarea = freakCard.querySelector('.equipment-notes');
            const notes = equipmentData[selectedEquipment] || "";
            notesTextarea.value = notes;
            autosizeTextarea(notesTextarea);
        }
        
        function generateRandomQuirk(button) {
            const freakCard = button.closest('.sheet-container');
            const quirkTextarea = freakCard.querySelector('.quirk-textarea');
            const randomIndex = Math.floor(Math.random() * quirkList.length);
            const randomQuirk = quirkList[randomIndex];
            quirkTextarea.value = `${randomQuirk.name}\n${randomQuirk.text}`;
            autosizeTextarea(quirkTextarea);
        }

        function generateRandomLeaderTrait(button) {
            const freakCard = button.closest('.sheet-container');
            const leaderTraitTextarea = freakCard.querySelector('.leader-trait-textarea');
            const randomIndex = Math.floor(Math.random() * leaderTraitList.length);
            const randomTrait = leaderTraitList[randomIndex];
            leaderTraitTextarea.value = `${randomTrait.name}\n${randomTrait.text}`;
            autosizeTextarea(leaderTraitTextarea);
        }

        function initializeFreakCard(freakCard) {
            // Find all interactive elements *within* this new card
            const attributesTable = freakCard.querySelector('.attribute-table');
            const equipmentSelect = freakCard.querySelector('.equipment-select');
            const generateQuirkBtn = freakCard.querySelector('.generate-quirk-btn');
            const leaderToggle = freakCard.querySelector('.is-leader-toggle');
            const generateLeaderTraitBtn = freakCard.querySelector('.generate-leader-trait-btn');
            const removeFreakBtn = freakCard.querySelector('.remove-freak-btn');
            const allTextareas = freakCard.querySelectorAll('textarea');

            // Attach Listeners
            attributesTable.addEventListener('change', event => {
                if (event.target.classList.contains('level-select')) {
                    updateAttributeRow(event.target);
                }
            });

            equipmentSelect.addEventListener('change', () => updateEquipmentNotes(equipmentSelect));
            generateQuirkBtn.addEventListener('click', () => generateRandomQuirk(generateQuirkBtn));
            generateLeaderTraitBtn.addEventListener('click', () => generateRandomLeaderTrait(generateLeaderTraitBtn));
            
            leaderToggle.addEventListener('change', () => {
                const leaderTraitSection = freakCard.querySelector('.leader-trait-section');
                const leaderTraitTextarea = freakCard.querySelector('.leader-trait-textarea');
                if (leaderToggle.checked) {
                    leaderTraitSection.classList.remove('hidden');
                } else {
                    leaderTraitSection.classList.add('hidden');
                    leaderTraitTextarea.value = ''; // Clear the trait if they are no longer a leader
                }
            });

            removeFreakBtn.addEventListener('click', () => {
                freakCard.remove();
                updateWarbandCost();
            });

            freakCard.addEventListener('input', event => {
                if (event.target.tagName.toLowerCase() === 'textarea') {
                    autosizeTextarea(event.target);
                }
            });

            // Initialize default states for this new card
            allTextareas.forEach(autosizeTextarea);
            freakCard.querySelectorAll('.level-select').forEach(updateAttributeRow);
            updateEquipmentNotes(equipmentSelect);
        }

        // --- GLOBAL EVENT LISTENERS ---
        themeToggle.addEventListener('click', () => {
            const isDarkMode = body.classList.toggle('dark-mode');
            const newTheme = isDarkMode ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        addFreakBtn.addEventListener('click', () => {
            const newFreak = freakTemplate.content.cloneNode(true);
            warbandContainer.appendChild(newFreak);
            
            const newCardElement = warbandContainer.lastElementChild;
            initializeFreakCard(newCardElement);
        });

        // --- INITIALIZATION ---
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        // Add the first freak automatically on page load
        addFreakBtn.click();

        });
    </script>

</body>
</html>
